<!DOCTYPE html>
<head>
  <title>Porffor</title>

  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">

  <meta itemprop="name" content="Porffor">
  <meta property="og:title" content="Porffor">
  <meta itemprop="description" content="A from-scratch experimental ahead-of-time JS -> Wasm compiler, written in JS">
  <meta property="og:description" content="A from-scratch experimental ahead-of-time JS -> Wasm compiler, written in JS">
  <meta property="og:type" content="website">

  <link rel="icon" type="image/png" href="logo.png">

  <style>
    @font-face {
      font-family: Whitney;
      font-style: normal;
      font-weight: 400;
      src: url(https://capybara.openasar.dev/whitney.woff2) format("woff2")
    }

    @font-face {
      font-family: Ginto;
      font-style: normal;
      font-weight: 500;
      src: url(https://capybara.openasar.dev/ginto.woff2) format("woff2")
    }

    :root {
      --font-normal: Whitney, "Helvetica Neue", Helvetica, Arial, sans-serif;
      --font-header: Ginto, "Helvetica Neue", Helvetica, Arial, sans-serif;
      --font-mono: Consolas, "Andale Mono WT", "Andale Mono", "Lucida Console", "Lucida Sans Typewriter", "DejaVu Sans Mono", "Bitstream Vera Sans Mono", "Liberation Mono", "Nimbus Mono L", Monaco, "Courier New", Courier, monospace;

      --header-primary: #ffffff;
      --header-secondary: #b9bbbe;

      /* --text-normal: #dcddde;
      --text-muted: #a3a6aa; */

      --text-normal: #ffffff;
      --text-muted: #c1c1c2;

      --accent: #8545cf;
      --accent-light: #9c60e0;
      --accent-dark: #6b2faf;

      --background-primary: #101418;
      --background-secondary: #202428;
      --background-header: 0, 4, 8;
    }

    html, body {
      margin: 0;
      padding: 0;
    }

    body {
      background: var(--background-primary);
    }

    * {
      box-sizing: border-box;
    }

    h1 {
      font-weight: 500;
      font-family: var(--font-header);
      font-size: 32px;

      color: var(--header-primary);

      margin: 0;
    }

    h2 {
      font-weight: 500;
      font-family: var(--font-header);
      font-size: 28px;

      color: var(--header-primary);

      margin-top: 60px;
      margin-bottom: 8px;
    }

    h2 > span {
      color: var(--text-muted);
      font-family: var(--font-normal);
      font-weight: normal;
      font-size: 18px;
      margin-left: 60px;
    }

    header {
      width: 100%;
      height: fit-content;

      padding: 4px 24px;

      background: rgba(var(--background-header), 0.6);
      box-shadow: 0 8px 16px rgb(0 0 0 / 24%);
      backdrop-filter: blur(2px) saturate(0.5);

      display: flex;
      align-items: baseline;

      position: sticky;
      top: 0;
      z-index: 10;
    }

    header > h1 {
      color: var(--accent-light);
    }

    header code {
      font-family: var(--font-mono);
      font-size: 20px;
      color: var(--text-muted);
    }

    header > div {
      flex-grow: 1;
      margin-left: 4vw;

      display: flex;
      gap: 50px;

      /* justify-content: flex-end; */
    }

    header a {
      color: var(--text-normal);
      text-decoration: none;

      font-weight: 500;
      font-family: var(--font-header);
      font-size: 24px;

      transition: .5s color;
    }

    a:not([href]) {
      cursor: pointer;
      color: var(--accent);
    }

    a:not([href]):hover {
      color: var(--accent-light);
    }

    a[href]::after {
      content: '';
      display: block;
      margin: auto;
      margin-top: 2px;
      height: 2px;
      width: 0px;
      background: transparent;
      transition: width .5s ease, background-color .5s ease;
    }

    header a:hover {
      color: var(--header-primary);
    }

    a[href]:hover::after {
      width: 100%;
      background: var(--accent-light);
    }

    a:active::after {
      width: 100%;
      background: var(--accent);
    }

    article {
      padding: 6px 50px;
      width: 100%;
      max-width: 2000px;
      margin: auto;
    }

    .tagline {
    }

    p {
      font-size: 18px;
      font-family: var(--font-normal);
      color: var(--text-muted);

      margin-bottom: 20px;
      margin-top: 0px;
    }

    .cards {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 80px;

      margin-top: 12px;
      margin-bottom: 60px;
    }

    .columns {
      grid-template-columns: repeat(2, 1fr);
    }

    .cards > div {
      background: var(--background-secondary);
      box-shadow: 0 8px 16px rgb(0 0 0 / 24%);
      padding: 16px;

      display: flex;

      border-radius: 8px;

      flex-direction: column;
    }

    .cards > div svg {
      width: 32px;
      height: 32px;
    }

    .cards > div svg.stroke path {
      stroke: currentColor;
      fill: none;
      stroke-width: 6px;
    }

    .cards > div > h1 {
      font-family: var(--font-header);
      color: var(--header-primary);

      display: flex;
      gap: 10px;

      align-items: center;
    }

    .cards > div > p {
      font-family: var(--font-normal);
      color: var(--text-normal);
      font-size: 22px;

      margin-top: 12px;
      margin-bottom: 10px;
    }

    .cards > span {
      color: var(--text-muted);
      font-family: var(--font-header);
      font-size: 28px;

      display: flex;
      align-items: center;
      justify-content: center;
    }

    .stats {
      display: flex;
      flex-direction: column;
      align-self: center;
    }

    .stats > h2 {
      margin: 0;
      color: var(--text-normal);
      font-weight: 400;

      display: flex;
      align-items: center;
    }

    .stats > h2:not(:last-child) {
      margin-bottom: 40px;
    }

    .stats span {
      font-weight: 600;
      color: var(--accent-light);
    }

    .stats svg {
      width: 32px;
      height: 32px;
      margin-right: 12px;
    }

    header .stats svg {
      width: 24px;
      height: 24px;
      margin-right: 8px;
    }

    .stats [id^="stat_"] {
      margin: 0 8px;
    }

    /* .stats::before {
      content: '';
      width: 80%;
      height: 2px;
      background: var(--background-secondary);
      margin: auto;

      position: relative;
      top: -4vw;
    }

    article > :nth-last-child(2) {
      margin-bottom: 4vw;
    } */

    a {
      color: var(--accent-light);
      text-decoration: none;
      font-weight: 600;

      display: inline-block;
    }

    ::-webkit-scrollbar {
      width: 12px;
    }

    ::-webkit-scrollbar-corner {
      background-color: transparent;
    }

    ::-webkit-scrollbar-thumb {
      background-color: #303438;
    }

    ::-webkit-scrollbar-track {
      background-color: #000408;
    }

    ::-webkit-scrollbar-thumb, ::-webkit-scrollbar-track {
      border: 4px solid transparent;
      background-clip: padding-box;
      border-radius: 12px;
    }

    table {
      background: #202428;
      color: var(--header-primary);
      font-family: var(--font-header);

      border-collapse: collapse;
      table-layout: fixed;
    }

    .compat tr:first-child {
      background: #101418;
      font-size: 20px;
    }

    .compat tr:first-child > td:nth-child(2), .compat tr:first-child > td:nth-child(3) {
      width: 160px;
    }

    .compat tr {
      border: 2px solid var(--header-secondary);
      font-size: 18px;
    }

    .compat td {
      padding: 4px;
      border: 2px solid black;
    }

    .compat td:not(:first-child) {
      text-align: center;
    }

    td.most {
      background: #97ca00;
    }

    td.some {
      background: #dfb317;
    }

    td.initial {
      background: #fe7d37;
    }

    td.unsupported {
      background: #e05d44;
    }

    .index {
      margin-bottom: 20px;
    }

    .index td {
      padding: 4px;
    }

    .index td:first-child {
      border-left: 3px solid transparent;
      padding-left: 10px;
    }

    .index td:nth-child(2) {
      width: 70%;
      color: var(--text-normal);
    }

    .sandbox-table {
      margin-top: 12px;
      margin-bottom: 12px;
    }

    .sandbox-table td {
      padding: 6px;
    }

    .sandbox-table td:last-child {
      text-align: center;
    }

    .detailed.cards {
      gap: 60px;
    }

    .detailed.cards p {
      font-size: 20px;
      margin-bottom: 20px;
    }

    .detailed.cards h2 {
      font-size: 24px;
      color: var(--text-normal);
      margin-top: 10px;
      margin-bottom: -4px;
    }

    .detailed.cards p + p {
      margin-top: 0;
    }

    ul, ol {
      margin-top: 0px;
      margin-bottom: 16px;

      color: var(--text-muted);
      font-family: var(--font-normal);
      font-size: 20px;
    }

    code {
      font-family: var(--font-mono);
      font-size: 80%;
      color: var(--text-muted);
    }

    .usage-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .usage-header code {
      font-size: 16px;
    }

    .check {
      border-radius: 50%;
      background: var(--accent);
      width: 20px;
      height: 20px;
    }

    .check.no {
      background: none;
    }

    .tagline {
      font-size: 32px;
    }

    .subtag {
      color: #dcddde;
      font-size: 18px;
      margin: 0;
      margin-top: 4px;
      margin-bottom: 26px;
    }

    #split {
      border-top: 1px solid #606468;
      display: grid;
      grid-template-columns: 60% 1fr;

      width: 100%;
      height: 70vh;
    }

    #split > :last-child {
      background: #0c0c0c;
      color: #d0d0d0;

      padding: 6px;

      font-family: var(--font-mono);
      font-size: 14px;
      border-left: 1px solid #606468;

      white-space: pre;

      height: 100%;
      overflow-x: hidden;
      overflow-y: auto;
    }

    #output, #status {
      border-top: 1px solid #606468;
      color: var(--text-muted);
      background: var(--background-secondary);
      font-family: var(--font-mono);

      width: 100%;
      height: 8vh;
      font-size: 14px;
      padding: 6px;

      white-space: pre;

      overflow-x: hidden;
      overflow-y: auto;
    }

    #status {
      padding: 4px;
      font-size: 14px;
      height: 26px;
    }

    .ansi-31 {
      color: rgb(197, 15, 31);
    }
    .ansi-34 {
      color: rgb(0, 55, 218);
    }
    .ansi-36 {
      color: rgb(58, 150, 221);
    }
    .ansi-35 {
      color: rgb(136, 23, 152);
    }
    .ansi-95 {
      color: rgb(180, 0, 158);
    }
    .ansi-33 {
      color: rgb(193, 156, 0);
    }
    .ansi-90 {
      color: rgb(118, 118, 118);
    }

    #wasm-size {
      position: absolute;
      right: 6px;
      top: 6px;
      pointer-events: none;
    }

    #split > * {
      position: relative;
    }

    #js-size {
      position: absolute;
      right: 24px;
      top: 6px;
      pointer-events: none;

      z-index: 9;

      font-family: var(--font-mono);
      font-size: 14px;
      color: #d0d0d0;

      display: none;
    }

    #args {
      background: var(--background-secondary);
      font-family: var(--font-mono);

      width: calc(100% - 800px);
      margin: 0;

      color: var(--text-normal);
      border: 0;
      padding: 6px;
      float: right;
      font-size: 14px;
    }

    #examples_dropdown {
      width: 180px;
      padding: 4px;
      height: 29px;
      display: inline-block;

      color: var(--text-normal);
      font-family: var(--font-normal);
      font-size: 16px;
      background: var(--background-secondary);
      border: none;

      margin-right: 20px;
    }

    article {
      color: var(--text-muted);
      font-family: var(--font-normal);
    }

    #valtype_dropdown, #opt_dropdown, #parser_dropdown, #target_dropdown {
      width: fit-content;
      padding: 4px;
      height: 29px;
      display: inline-block;

      color: var(--text-normal);
      font-family: var(--font-normal);
      font-size: 14px;
      background: var(--background-secondary);
      border: none;

      margin-left: 4px;
      margin-right: 12px;
    }

    #test262 {
      display: grid;
      grid-template-columns: 400px 1fr;
      gap: 24px;

      width: 100%;
      /* height: 80vh; */
      height: 800px;

      margin-bottom: 60px;
    }

    #commit_log {
      display: grid;
      grid-template-columns: 1fr;
      gap: 24px;

      overflow-x: auto;
    }

    #commit_log > div {
      display: flex;
      flex-direction: column;

      background: var(--background-secondary);
      padding: 8px;
      border-radius: 8px;
    }

    #commit_log > div > :first-child {
      font-size: 18px;
      font-weight: 500;
      color: var(--text-normal);
    }

    #commit_log > div > :last-child {
      font-size: 18px;
      font-weight: 500;

      color: #57F287;

      margin-top: 6px;
    }

    #commit_log > div > :last-child > span {
      color: var(--text-muted);
      font-size: 16px;
      margin-left: 6px;
    }

    #commit_log > div > :last-child > div {
      font-size: 16px;
      font-weight: 400;
      color: var(--text-muted);

      display: inline;
      float: right;
    }

    #graph {
      max-width: 100%;
      height: 100%;
      color: var(--text-muted);

      border-radius: 8px;
      background: var(--background-secondary);
      position: relative;
    }

    #graph span {
      position: absolute;
      right: 12px;
      top: 50px;
      font-size: 12px;
      color: var(--text-muted);
      font-weight: 400;
      cursor: default;
    }

    #graph_legend {
      position: absolute;
      left: 12px;
      top: 12px;

      display: flex;
      overflow: hidden;

      color: var(--text-normal);
      padding: 6px;
      font-size: 20px;
      gap: 40px;
    }

    #graph_legend div::before {
      content: "";
      display: inline-block;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: var(--color);
      margin-right: 10px;
      vertical-align: middle;
    }

    #graph_time {
      position: absolute;
      right: 16px;
      top: 16px;
      color: var(--text-muted);

      border-radius: 16px;
      background: #000408;

      display: flex;
      overflow: hidden;
    }

    #graph_time div {
      font-size: 18px;
      padding: 8px 12px;
      cursor: pointer;
    }

    #graph_time div.active {
      background: var(--accent);
      color: var(--text-normal);
    }

    #graph_time div:not(:last-child) {
      border-right: 2px solid #101418;
    }

    a.simple {
      color: inherit;
      font-weight: inherit;
    }

    a.simple:hover {
      text-decoration: underline;
    }

    a.simple::after {
      display: none;
    }

    #graph svg {
      width: 100%;
      height: calc(100% - 60px);
      margin-top: 60px;
    }

    #graph text {
      cursor: default;
      stroke: var(--text-muted);
      font-size: 22px;
      text-rendering: optimizeLegibility;
    }

    header img {
      vertical-align: middle;
      border-radius: 4px;
      margin-right: 8px;
      margin-bottom: 6px;
    }

    span[title] {
      text-decoration: underline 1px dotted var(--text-muted);
    }
  </style>
</head>

<body>
  <header>
    <h1><img width="32" src="logo.png">Porffor</h1>

    <div>
      <a href="https://github.com/CanadaHonk/porffor">GitHub</a>
    </div>
  </header>

  <article>
    <h1 class="tagline">A from-scratch experimental AOT JS -> Wasm compiler, written in JS</h1>
    <!-- <h2 class="subtag">about as insane as it sounds</h2> -->

    <p>Porffor is a unique JS engine, compiling given JS code to a Wasm binary ahead-of-time. It is seriously limited, but what it can do, it does pretty well. Written from scratch except parser.</p>

    <select id="examples_dropdown"></select>
    <!-- Valtype <select id="valtype_dropdown"></select> -->
    <span title="Optimization level">-O</span> <select id="opt_dropdown"></select>
    <span title="JS parser to use">Parser</span> <select id="parser_dropdown"></select>
    <span title="Experimental!">Target</span> <select id="target_dropdown"></select>
    <input type="text" placeholder="Extra arguments" id="args">
    <div id="split"></div>
    <div id="output"></div>
    <div id="status"></div>

    <h2>Test262 <span><a class="simple" href="https://github.com/tc39/test262">Test262</a> is the official ECMAScript conformance test suite. Porffor is ran against it each commit to track conformance progress!</span></h2>
    <div id="test262">
      <div id="commit_log"></div>
      <div id="graph">
        <div id="graph_legend"></div>
        <div id="graph_time">
          <div id="graph_time_3">3 months</div>
          <div id="graph_time_6">6 months</div>
          <div class="active" id="graph_time_all">all-time</div>
        </div>
        <svg xmlns="http://www.w3.org/2000/svg" preserveAspectRatio="none" id="svg"></svg>
      </div>
    </div>
  </article>

  <script> (async () => {
    const loadScript = async x => {
      const el = document.createElement('script');
      el.src = x;
      document.head.append(el);

      await new Promise(res => el.onload = res);
    };

    if (!window.monaco) {
      await loadScript('https://cdn.openasar.dev/monaco-editor/min/vs/loader.js');
      // await new Promise(res => setTimeout(res, 500));

      require.config({ paths: { vs: 'https://cdn.openasar.dev/monaco-editor/min/vs' } });
      await new Promise(res => require(['vs/editor/editor.main'], res));
    }

    const monacoContainer = document.createElement('div');
    // monacoContainer.style.width = '100%';
    // monacoContainer.style.height = '75vh';
    split.appendChild(monacoContainer);

    const jsSize = document.createElement('div');
    jsSize.id = 'js-size';
    monacoContainer.append(jsSize);

    const wasmView = document.createElement('div');
    split.appendChild(wasmView);

    const status = document.getElementById('status');

    const examples = {
'Prime Numbers': `function isPrime(number) {
  if (number < 2) return false;

  for (let i = 2; i < number; i++) {
    if (number % i == 0) return false;
  }

  return true;
}

let counter = 0;
while (counter <= 10000) {
  if (isPrime(counter)) console.log(counter);
  counter++;
}`,
'Fibonacci': `let a = 0, b = 1;
console.log(a); console.log(b);

for (let i = 2; i <= 45; i++) {
  let t = b + a;
  a = b;
  b = t;

  console.log(t);
}`,
'Factorial': `const factorial = n => n === 0 ? 1 : (n * factorial(n - 1));
console.log(factorial(10));`,
'Sum of Digits': `let n = 654, sum = 0;
while (n > 0) {
  sum += n % 10;
  n /= 10;
}

console.log(sum);`,
'Exception': `throw new Error('Hello, world!')`,
'Array Reading': `let arr = [ 2, 4, 8, 16 ];
for (let i = 0; i < arr.length; i++) console.log(arr[i]);`,
'Array Prototype': `let arr = [ 1, 2, 3 ];
arr.push(4); // 4
arr.shift(); // 1
arr.pop(); // 4

arr.at(0); // 2
arr.at(-1); // 3`,
'Math Proposals': `console.log(Math.signbit(1)) // false
console.log(Math.signbit(-1)) // true
console.log(Math.radians(180)) // 3.141592...
console.log(Math.RAD_PER_DEG) // 0.017453...
console.log(Math.clamp(12, 0, 10)) // 10
console.log(Math.scale(4, 0, 10, 0, 1)) // 0.4`,
    };
    const defaultExample = 'Prime Numbers';
    let code = examples[defaultExample];

    const addOptions = (container, options, def) => {
      for (const x of options) {
        const el = document.createElement('option');
        el.textContent = x;
        el.selected = x === def;

        container.appendChild(el);
      }
    };

    addOptions(examples_dropdown, Object.keys(examples), defaultExample);

    if (location.hash) {
      code = atob(location.hash.slice(1));
      examples_dropdown.selectedIndex = -1;
    }

    // addOptions(valtype_dropdown, [ 'i32', 'i64', 'f64' ], 'f64');
    addOptions(opt_dropdown, [ 0, 1, 2, 3 ], 1);
    addOptions(parser_dropdown, ['acorn', 'meriyah', 'hermes-parser', '@babel/parser'], 'acorn');
    addOptions(target_dropdown, ['wasm', 'c'], 'wasm');

    examples_dropdown.oninput = () => {
      code = examples[examples_dropdown.value];
      editor.setValue(code);
      comp();
    };

    // valtype_dropdown.oninput = opt_dropdown.oninput = parser_dropdown.oninput = target_dropdown.oninput = () => comp();
    opt_dropdown.oninput = target_dropdown.oninput = () => comp();

    parser_dropdown.oninput = async () => {
      setProcess();
      await globalThis._porf_loadParser();
      comp();
    };

    window.editor = monaco.editor.create(monacoContainer, {
      value: code,
      codeLens: false,
      language: 'javascript',
      theme: 'vs-dark',
      minimap: {
        enabled: false
      }
    });

    const debounce = (handler, timeout) => {
      let timer;
      return (...args) => {
        clearTimeout(timer);
        timer = setTimeout(() => handler(...args), timeout);
      };
    };

    const setProcess = () => {
      globalThis.process = {
        argv: ['', '', ...args.value.split(' '), `-O${opt_dropdown.value}`, `--parser=${parser_dropdown.value}`, `--target=${target_dropdown.value}`]
      };
    };

    setProcess();
    const compile = (await import('../compiler/wrap.js')).default;

    const comp = async () => {
      setProcess();
      if (code !== examples[examples_dropdown.value]) location.hash = '#' + btoa(code);

      jsSize.textContent = `${new Blob([code]).size} bytes`;

      let cache = '';
      const print = str => {
        cache += str;

        if (str === '\n') {
          // output.textContent += cache;
          // cache = '';
        }
      };

      output.textContent = '';
      wasmView.innerHTML = '';
      status.textContent = 'Compiling...';

      let wasm, exports, times, decomps, c;
      try {
        0, { wasm, exports, times, decomps, c } = await compile(code, [ 'module', 'decomp' ], {}, print);
      } catch (e) {
        console.error(e);
        status.textContent = `${e.constructor.name}: ${e.message}`;
        return;
      }

      if (target_dropdown.value === 'c') {
        wasmView.textContent = c.trim();
      } else {
        wasmView.innerHTML = `<div id="wasm-size">${wasm.byteLength} bytes</div>` + decomps.join('\n').replaceAll('\x1B[0m', '</span>').replace(/\x1B\[([0-9]{2})m/g, (_, esc) => `<span class="ansi-${esc}">`);
      }

      status.textContent = `Compiled in ${times[0].toFixed(0)}ms`;

      await new Promise(res => setTimeout(res, 10));

      const t2 = performance.now();
      try {
        exports.main();
      } catch (e) {
        console.error(e);
        status.textContent = `${e.constructor.name}: ${e.message}`;
        return;
      }

      print('\n');

      const execTime = performance.now() - t2;
      status.textContent += `. Executed in ${execTime.toFixed(0)}ms`;

      output.textContent = cache;
    };

    const compDebounce = debounce(comp, 500);

    editor.getModel().onDidChangeContent(e => {
      code = editor.getValue();
      compDebounce();
    });

    args.oninput = () => compDebounce();

    comp();

    const niceDate = x => {
      return x.toLocaleString('default', {
        month: 'long',
        day: 'numeric',
        hour: 'numeric',
        minute: 'numeric'
      });
    };

    const history = await (await fetch('/test262/history.json')).json();

    for (let i = 0; i < 100; i++) {
      const x = history[i];
      const el = document.createElement('div');

      const textEl = document.createElement('div');
      textEl.textContent = x.title.slice(0, 42) + (x.title.length > 42 ? '...' : '');

      const when = new Date(x.time);
      const whenEl = document.createElement('div');
      whenEl.textContent = niceDate(when);

      const percent = x.results[0];
      const prevPercent = history[i + 1].results[0];

      const change = percent - prevPercent;
      if (change === 0) continue;

      const percentEl = document.createElement('div');
      percentEl.innerHTML = `${percent.toFixed(2)}%${change !== 0 ? `<span>(${change > 0 ? '+' : ''}${change.toFixed(2)})</span>` : ''}`;

      percentEl.append(whenEl);

      el.append(textEl, percentEl);
      commit_log.append(el);
    }

    const colors = {
      pass: '#57f287',
      fail: '#fee75c',
      runtimeError: '#ed4245',
      compileError: '#6f0b0c'
    };

    for (const x in colors) {
      const name = x.replace(/[a-z][A-Z]/, _ => `${_[0]} ${_[1].toLowerCase()}`);
      const el = document.createElement('div');
      el.textContent = name;
      el.style = `--color: ${colors[x]}`;

      graph_legend.appendChild(el);
    }

    const makeGraph = () => {
      const timeFrame = [graph_time_3, graph_time_6, graph_time_all].find(x => x.className === 'active').textContent;

      let cutoff;
      if (timeFrame.endsWith('months')) {
        cutoff = new Date();
        cutoff.setMonth(cutoff.getMonth() - parseInt(timeFrame[0]));
      } else {
        const oldest = new Date(history.at(-1).time);
        const now = new Date();
        const months = now.getMonth() - oldest.getMonth() + (12 * (now.getFullYear() - oldest.getFullYear())) + 1;
        graph_time_all.textContent = `all-time (${months} months)`;
      }

      if (cutoff) for (let i = 0; i < history.length; i++) {
        const d = new Date(history[i].time);
        if (d < cutoff) {
          cutoff = i;
          break;
        }
      }

      cutoff ??= history.length;

      const oldest = history[cutoff - 1].time;
      const newest = history[0].time;
      const dateRange = newest - oldest;

      const availableWidth = Math.min(window.innerWidth, 2000) - 400 - 24;
      const availableHeight = 800;
      const aspectRatio = availableWidth / availableHeight;

      const width = 1000 * aspectRatio;
      const height = 1000;

      const leftAxisWidth = 80;
      const padding = 20;

      // const upperBound = 20; // 100
      // const lowerBound = 10; // 0

      svg.setAttribute('viewBox', `0 0 ${width + leftAxisWidth + padding*2} ${height + padding*2}`);
      svg.innerHTML = '';

      // left axis line
      const leftAxisLine = document.createElementNS('http://www.w3.org/2000/svg', 'line');
      leftAxisLine.setAttribute('x1', padding + leftAxisWidth);
      leftAxisLine.setAttribute('x2', padding + leftAxisWidth);
      leftAxisLine.setAttribute('y1', padding);
      leftAxisLine.setAttribute('y2', height + padding);
      leftAxisLine.setAttribute('stroke', '#000408');
      svg.appendChild(leftAxisLine);

      // const gridlinesEvery = 1;
      const gridlinesEvery = 5;
      // for (let i = lowerBound; i <= upperBound; i += gridlinesEvery) {
      for (let i = 0; i <= 100; i += gridlinesEvery) {
        const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
        line.setAttribute('x1', (leftAxisWidth + padding).toFixed());
        line.setAttribute('x2', (width + leftAxisWidth + padding).toFixed());

        // const y = (padding + (1 - ((i - lowerBound) / (upperBound - lowerBound))) * height).toFixed();
        const y = (padding + (1 - (i / 100)) * height).toFixed();
        line.setAttribute('y1', y);
        line.setAttribute('y2', y);
        line.setAttribute('stroke', '#000408');
        svg.appendChild(line);

        const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
        text.setAttribute('x', padding + leftAxisWidth - 16);
        // text.setAttribute('y', +y + ((i - lowerBound) / (upperBound - lowerBound)) * 10);
        text.setAttribute('y', +y + (i / 100) * 10);
        text.setAttribute('text-anchor', 'end');

        text.textContent = `${i}%`;
        svg.appendChild(text);
      }

      const addCircle = (x, y, color) => {
        const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
        circle.setAttribute('cx', x);
        circle.setAttribute('cy', y);
        circle.setAttribute('r', 3);
        circle.setAttribute('fill', color);
        svg.appendChild(circle);
      };

      const points = {
        pass: [],
        fail: [],
        runtimeError: [],
        compileError: []
      };

      for (let i = 0; i < cutoff; i++) {
        const [ percent, total, pass, fail, runtimeError, wasmError, compileError, timeout, todo ] = history[i].results;

        const when = (history[i].time - oldest) / dateRange;
        const x = (padding + leftAxisWidth + when * width).toFixed();

        const run = (n, type) => {
          const y = (padding + (1 - (n / total)) * height).toFixed();
          points[type].push(`${x},${y}`);
          addCircle(x, y, colors[type]);
        };

        run(pass, 'pass');
        run(fail, 'fail');
        run(runtimeError + todo + timeout, 'runtimeError');
        run(compileError + wasmError, 'compileError')
      }

      const addLine = (points, color) => {
        const polyline = document.createElementNS('http://www.w3.org/2000/svg', 'polyline');
        polyline.setAttribute('fill', 'none');
        polyline.setAttribute('stroke', color);
        polyline.setAttribute('stroke-width', 3);
        polyline.setAttribute('points', points.join(' '));
        svg.appendChild(polyline);
      };

      for (const x in points) {
        addLine(points[x], colors[x]);
      }
    };
    makeGraph();
    window.addEventListener('resize', makeGraph);

    graph_time_3.onclick = () => {
      [graph_time_6, graph_time_all].forEach(x => x.className = '');
      graph_time_3.className = 'active';
      makeGraph();
    };

    graph_time_6.onclick = () => {
      [graph_time_3, graph_time_all].forEach(x => x.className = '');
      graph_time_6.className = 'active';
      makeGraph();
    };

    graph_time_all.onclick = () => {
      [graph_time_3, graph_time_6].forEach(x => x.className = '');
      graph_time_all.className = 'active';
      makeGraph();
    };
  })();</script>
</body>